<!DOCTYPE html>
<!-- by xuanzhi33 -->
<html>

<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#e9f1e9">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Data</title>
  <link href="https://unpkg.zhimg.com/bootstrap@4.4.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet"
    href="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href="https://www.xuanzhi33.cn/css/x-az.css" rel="stylesheet">
  <link rel="icon" href="https://www.xuanzhi33.cn/favicon.ico">
  <style>
    .v-enter-active,
    .v-leave-active {
      transition: all 0.3s;
    }

    .v-enter-from,
    .v-leave-to {
      opacity: 0;
      transform: translateY(50px);
    }

    .table td, .table th {
      padding: 0.25rem;
    }
  </style>
  <script>
    var _hmt = _hmt || [];
    (function () {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?2a6aca6b85659d07cf5d9e5417c4a5f5";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>
</head>

<body>
  <br class="brBefore">
  <br class="brBefore">
  <div class="container" id="app"></div>
  <br>
  <br>

  <template id="main">
    <div class="card glass"> <br>
      <div class="container">
        <h1 class="text-center">
          <i class="fa fa-database"></i>
          Data Manage
          <i class="fa fa-refresh fa-spin" v-if="loading"></i>
        </h1>
        <div v-if="isLogin">

          <table class="table mt-3 table-hover">
            <thead>
              <tr>
                <th>
                  ID
                </th>
                <th>
                  Name
                </th>
                <th>
                  Date
                </th>
                <th>
                  Action
                </th>
              </tr>
            </thead>
            <tbody>
              <template v-if="data.length == 0">
                <tr>
                  <td colspan="4" class="text-center">
                    <i class="fa fa-minus-circle"></i>
                    No data
                  </td>
                </tr>
              </template>
              <template v-else>
                <tr v-for="item in data">
                  <td>
                    {{ item.id }}
                  </td>
                  <td>
                    {{ item.user }}
                    <a href="#" @click.prevent="rename(item)" title="Rename">
                      <i class="fa fa-edit"></i>
                    </a>
                  </td>
                  <td>
                    {{ item.createTime }}
                  </td>
                  <td>
                    <a href="#" @click.prevent="makeCSV(item.data, item.user)">
                      <i class="fa fa-download"></i>
                    </a> &nbsp;
                    <a href="#" @click.prevent="delData(item)">
                      <i class="fa fa-trash"></i>
                    </a>
                  </td>
                </tr>
              </template>

            </tbody>
          </table>
          <div class="clear-fix mb-5">
            <div class="float-left">
              <a href="#" @click.prevent="getData">
                <i class="fa fa-refresh"></i>
              </a>&emsp;
              <i class="fa fa-user"></i>
              {{ username }}&nbsp;
              <a href="#" @click.prevent="logout">
                <i class="fa fa-sign-out"></i>
              </a>&nbsp;
              
            </div>
            <div class="float-right">
              Page
              <select v-model="page">
                <option v-for="i in totalPage">{{ i }}</option>
              </select>
            </div>
          </div>

        </div>
        <div v-else>
          <p v-if="loginErr">
            <i class="fa fa-exclamation-triangle"></i>
            You have no permission to access this page. Please login again.
          </p>
          <p v-else>Please login first.</p>
          <button class="btn btn-success btn-block" @click="login" :disabled="gotoLogin">
            <span class="spinner-border spinner-border-sm" v-if="gotoLogin"></span>
            <i class="fa fa-sign-in"></i>
            Login
          </button>
        </div>
      </div>
      <br>
    </div>
  </template>

  <script>
    const urlParam = name => {
      const serchParams = new URLSearchParams(window.location.search);
      return serchParams.get(name);
    }

    if (urlParam("username")) {
      const token = {
        username: urlParam("username"),
        token: urlParam("ticket")
      }
      localStorage.setItem("x-token", JSON.stringify(token));
      history.replaceState(null, "", location.href.split("?")[0]);
    }
  </script>
  <script src="https://www.xuanzhi33.cn/js/global.v2.js" data-sendinfo="no"></script>
  <script src="https://unpkg.zhimg.com/vue@3/dist/vue.global.prod.js"></script>
  <script type="module">
    const { createApp } = Vue;


    const app = createApp({
      data() {
        return {
          data: [],
          loading: false,
          gotoLogin: false,
          loginErr: false,
          pageSize: 10,
          page: 1,
          total: 0,
          isLogin: true,
          username: "",
          token: ""
        }
      },
      async mounted() {
        if (!this.checkToken()) return;

        const creds = JSON.parse(localStorage.getItem("x-token"));
        this.username = creds.username;
        this.token = creds.token;

        await this.getData();
      },
      computed: {
        totalPage() {
          return Math.ceil(this.total / this.pageSize);
        }
      },
      watch: {
        page() {
          this.getData();
        }
      },
      methods: {
        login() {
          this.gotoLogin = true;
          location.href = "https://api.xuanzhi33.cn/v1/usersystem/?appname=Car%20Project&from=https://gh.xuanzhi33.cn/carproject/data.html";
        },
        logout() {
          localStorage.removeItem("x-token");
          this.isLogin = false;
        },
        checkToken() {
          const token = localStorage.getItem("x-token");
          if (!token) {
            this.isLogin = false;
            return false;
          }

          return true;
        },
        async ajax(method, path, body) {
          const url = "https://s.x-33.top/carproject" + path;
          this.loading = true;
          const res = await fetch(url, {
            method,
            headers: {
              "Content-Type": "application/json",
              "Xuanzhi33-User": this.username,
              "Xuanzhi33-Token": this.token
            },
            body: JSON.stringify(body)
          });
          const data = await res.json();
          this.loading = false;
          if (data.code == 200) {
            return data.data;
          } else if (data.code == 401) {
            this.loginErr = true;
            this.logout();
          } else {
            alert(data.message);
          }
        },
        async getData() {
          const res = await this.ajax("POST", "/api/get", {
            page: this.page,
            pageSize: this.pageSize
          });
          if (!res) return;

          this.data = res.data;
          this.total = res.total;
        },
        async rename(item) {
          const newName = prompt("Please enter the new name:", item.user);
          if (!newName) return;

          const res = await this.ajax("PUT", "/api/rename", {
            id: item.id,
            newName
          });
          if (!res) return;

          this.getData();
        },
        async delData(item) {
          if (!confirm(`Are you sure to delete "${item.user}" (id: ${item.id})?`)) return;

          const res = await this.ajax("DELETE", "/api/delete/" + item.id, {});
          if (!res) return;

          this.getData();
        },
        async makeCSV(textData, fileName) {
          const records = JSON.parse(textData);
          const csv = records.map(record => record.join(',')).join('\n');
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${fileName}.csv`;
          a.click();
        }
      },
      template: "#main"
    });

    app.mount("#app");
  </script>
</body>

</html>