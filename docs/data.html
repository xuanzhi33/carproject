<!DOCTYPE html>
<!-- by xuanzhi33 -->
<html>

<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#e9f1e9">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Data</title>
  <link href="https://unpkg.zhimg.com/bootstrap@4.4.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://www.xuanzhi33.cn/css/x-az.css" rel="stylesheet">
  <link rel="icon" href="https://www.xuanzhi33.cn/favicon.ico">
  <style>
    .v-enter-active,
    .v-leave-active {
      transition: all 0.3s;
    }

    .v-enter-from,
    .v-leave-to {
      opacity: 0;
      transform: translateY(50px);
    }
  </style>
  <script>
    var _hmt = _hmt || [];
    (function () {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?2a6aca6b85659d07cf5d9e5417c4a5f5";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>
</head>

<body>
  <br class="brBefore">
  <br class="brBefore">
  <div class="container" id="app"></div>
  <br>
  <br>

  <template id="main">
    <div class="card glass"> <br>
      <div class="container" v-if="isLogin">
        <h1 class="text-center">Data</h1>
        <table class="table mt-3">
          <thead>
            <tr>
              <th>
                ID
              </th>
              <th>
                Name
              </th>
              <th>
                Date
              </th>
              <th>
                Excel
              </th>
            </tr>
          </thead>
          <tbody>

            <template v-if="loading">
              <tr v-for="i in pageSize">
                <td colspan="4">
                  <span class="spinner-border spinner-border-sm"></span>
                  Loading...
                </td>
              </tr>
            </template>
            <template v-else-if="data.length == 0">
              <tr>
                <td colspan="4" class="text-center">
                  No data
                </td>
              </tr>
            </template>
            <template v-else>
              <tr v-for="item in data">
                <td>
                  {{ item.id }}
                </td>
                <td>
                  {{ item.user }}
                </td>
                <td>
                  {{ item.createTime }}
                </td>
                <td>
                  <a href="#" @click.prevent="makeCSV(item.data, item.user)">Download</a>
                </td>
              </tr>
            </template>

          </tbody>
        </table>
        <div class="clear-fix mb-5">
          <div class="float-left">
            <a href="#" @click.prevent="getData">Refresh</a>&nbsp;
            <a href="#" @click.prevent="logout">Logout</a>&nbsp;
            User: {{ username }}
          </div>
          <div class="float-right">
            Page
            <select v-model="page">
              <option v-for="i in totalPage">{{ i }}</option>
            </select>
          </div>
        </div>

      </div>
      <div class="container" v-else>
        <h1 class="text-center">Data</h1>
        <p>Please login first.</p>
        <button class="btn btn-success btn-block" @click="login" :disabled="gotoLogin">
          <span class="spinner-border spinner-border-sm" v-if="gotoLogin"></span>
          Login
        </button>
      </div>
      <br>
    </div>
  </template>

  <script>
    const urlParam = name => {
      const serchParams = new URLSearchParams(window.location.search);
      return serchParams.get(name);
    }

    if (urlParam("username")) {
      const token = {
        username: urlParam("username"),
        token: urlParam("ticket")
      }
      sessionStorage.setItem("x-token", JSON.stringify(token));
      history.replaceState(null, "", location.href.split("?")[0]);
    }
  </script>
  <script src="https://www.xuanzhi33.cn/js/global.v2.js"></script>
  <script src="https://unpkg.zhimg.com/vue@3/dist/vue.global.prod.js"></script>
  <script type="module">
    const { createApp } = Vue;


    const app = createApp({
      data() {
        return {
          data: [],
          loading: true,
          gotoLogin: false,
          pageSize: 10,
          page: 1,
          total: 0,
          isLogin: true,
          username: "",
          token: ""
        }
      },
      async mounted() {
        if (!this.checkToken()) return;

        const creds = JSON.parse(sessionStorage.getItem("x-token"));
        this.username = creds.username;
        this.token = creds.token;

        await this.getData();
      },
      computed: {
        totalPage() {
          return Math.ceil(this.total / this.pageSize);
        }
      },
      watch: {
        page() {
          this.getData();
        }
      },
      methods: {
        login() {
          this.gotoLogin = true;
          location.href = "https://api.xuanzhi33.cn/v1/usersystem/?appname=Car%20Project&from=https://gh.xuanzhi33.cn/carproject/data.html";
        },
        logout() {
          sessionStorage.removeItem("x-token");
          this.isLogin = false;
        },
        checkToken() {
          const token = sessionStorage.getItem("x-token");
          if (!token) {
            this.isLogin = false;
            return false;
          }

          return true;
        },
        async getData() {
          this.loading = true;
          const res = await fetch("https://s.x-33.top/carproject/api/get", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Xuanzhi33-User": this.username,
              "Xuanzhi33-Token": this.token
            },
            body: JSON.stringify({
              page: this.page,
              pageSize: this.pageSize
            })
          });
          const data = await res.json();
          if (data.code == 200) {
            const records = data.data;
            this.data = records.data;
            this.total = records.total;
          } else if (data.code == 401) {
            this.logout();
          } else {
            alert("Error");
          }
          this.loading = false;
        },
        async makeCSV(textData, fileName) {
          const records = JSON.parse(textData);
          const csv = records.map(record => record.join(',')).join('\n');
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${fileName}.csv`;
          a.click();
        }
      },
      template: "#main"
    });

    app.mount("#app");
  </script>
</body>

</html>